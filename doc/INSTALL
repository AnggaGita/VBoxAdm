========================================================
=
= WARNING
=
========================================================

THIS IS APLHA QUALITY SOFTWARE WHICH IS STILL LARGELY UNTESTED.

USE WITH CARE!

YOU HAVE BEEN WARNED.

This notice will be removed once I think it has received enough testing.

How to Install VBoxAdm
======================

* Prerequisites
- MySQLd
- Lighttpd (or Apache)
- PHP5
- Perl
- CGI::Application
- CGI::Application::Plugin::DBH
- CGI::Application::Plugin::Redirect
- CGI::Application::Plugin::Session
- CGI::Application::Plugin::TT
- CGI::Application::Plugin::RequireSSL
- CGI::Application::Plugin::Authentication
- Config::Std
- Famfamfam Silk Icons
- Dovecot 1.2.x (Version 2.x is untested, but should work with minor adustments)
- Postfix 2.6+

* Install MySQL
In the default setup we need InnoDB. If you want to avoid InnoDB you can change the schema,
but beware: This application relies on working foreign key contraints. So embrace errors if you
skip InnoDB.

* Create the Databases
mysql> CREATE DATABASE vboxadm;
mysql> CREATE DATABASE roundcube;

* Create Database Accounts
- vboxadm
GRANT ALL ON vboxadm.* TO 'vboxadm'@'localhost' IDENTIFIED BY '';
- postfix
GRANT SELECT ON vboxadm.* TO 'vboxadm'@'localhost' IDENTIFIED BY '';
- dovecot
GRANT SELECT ON vboxadm.mailboxes TO 'vboxadm'@'localhost' IDENTIFIED BY '';
GRANT SELECT ON vboxadm.domains TO 'vboxadm'@'localhost' IDENTIFIED BY '';
- roundcube
GRANT ALL ON roundcube.* TO 'roundcube'@'localhost' IDENTIFIED BY '';
- vboxadm_user (for vacation and pw change)
GRANT SELECT,UPDATE ON vboxadm.mailboxes TO 'vboxadm_user'@'localhost' IDENTIFIED BY '';
GRANT SELECT ON vboxadm.domains TO 'vboxadm_user'@'localhost' IDENTIFIED BY '';

* Load Schema
$> mysql -uvboxadm -p vboxadm < doc/mysql/schema.sql

* Install Lighttpd
Enable cgi (or fastcgi) and symlink the lighttpd/12-vboxadm.conf to /etc/lighttpd/conf-enabled/12-vboxadm.conf.
Restart lighttpd.

* Install Roundcube

Unpack Roundcube to /opt/roundcube, create a symlink from /opt/roundcube/roundcube-0.x.y/
/opt/roundcube/current.
The use the installer and follow the instructions of the installer. Use the database
and user created above.

When the installer has created the config for you place them in /opt/roundcube/config/main.inc.php and db.inc.php
and symlink from /opt/roundcube/config/{db,main}.inc.php to /opt/roundcube/current/config/. 

* Install Roundcube Plugin: vacation

Since the vacation plugin is not contained in the upstream sources of roundcube, a modified version is supplied
with VBoxAdm. Copy the folder contrib/roundcube/plugins/vacation to your roundcube plugins folder.

* Configure Roundcube Plugins

Edit plugins/vacation/config.ini and set a dsn in the default section:
dsn = "mysql://vboxadm_user:password@localhost"

Copy the config.inc.php.dist in plugins/password to config.inc.php and set the dsn
$rcmail_config['password_db_dsn'] = 'mysql://vboxadm_user:password@localhost/vboxadm';

and the password query:
$rcmail_config['password_query'] = "UPDATE vboxadm.mailboxes SET password = %p WHERE local_part = %l AND password = %o AND domain_id = (SELECT id FROM vboxadm.domains WHERE name = %d)";

Copy the config.inc.php.dist in plugins/managesieve to config.inc.php.

* Active the Roundcube Plugins

Edit the file config/main.inc.php and add the plugins 'password', 'managesieve' and 'vacation'.

$rcmail_config['plugins'] = array('password','managesieve', 'vacation');

* Configure Postfix
Copy all files and subdirs of doc/postfix to /etc/postfix.

* Configure Dovecot
Copy all files of doc/dovecot to /etc/dovecot.

* Configure Vacation
Create the required system user and you should be ready to go.
TODO configure the vacation tool

* Configure SMTP-Proxy
Create an init script.
TODO configure the SMTP-Proxy

* Install VBoxAdm
To build and install this application use the supplied Makefile:
	make clean
	make all
	make install

You may set DESTDIR when running make install to specify another prefix
than the default one in /usr. Just run the make install command like this:
	DESTDIR=/your/prefix/ make install

Contributing
============
Bug reports, Patches and comments are welcome. Just send them
to me at dominik.schulz@gauner.org. If you send perl testcases
along with your bug report or patch it'll get the highest priority
on my todo list.

Packaging
=========
I'd really love to see this application packaged for the differnt
distributions out there. If you plan to create a package for an
Debian-based distribution contact me and I'll send you my preliminary
packaing information for this application. If you've created
a packaged version of this application please let me know.