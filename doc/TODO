TODO:
- Vacation Handling
use/adapt postfixadmin vacation.pl for vacation handling

- Roundcube Plugin
no user logins to vboxadm, only domainadmins and superadmins.
the user part is handled by a roundcube plugin
http://trac.roundcube.net/wiki/Doc_Plugins
http://trac.roundcube.net/browser/trunk/plugins/password
-> DONE, see INSTALL and contrib

- Password Schemes
Select correct password scheme -> DONE: Plaintext, blame M$

- Max_msg_size
implement Policy-Daemon based on http://www.corpit.ru/mjt/smtpd-policy-template.pl

- Debianiazion
Create debian package

- Amavis Konfiguration
-- see http://www.gentoo.org/doc/en/mailfilter-guide.xml and
implement per recipient configuration of:
* spam filtering
* virus filtering
* bad header filtering
* spam subject rewrite
* spam quarantine
* spam tag level
* spam tag2 level
* spam kill level

Add
@lookup_sql_dsn =
   ( ['DBI:mysql:maildb:host1', 'mail', 'very_secret_password']  );

and
$sql_select_policy = 'SELECT m.id AS id,CONCAT(m.local_part,'-',d.name) AS policy_name,
no_av, no_sa, want_badfiles, want_badheader, no_av, no_sa, want_badfiles, want_badheader, sa_rewritesubj, sa_tag_level, sa_tag2_level, sa_kill_level, m.id
FROM mailboxes AS m LEFT JOIN domains AS d ON m.domain_id = d.id WHERE CONCAT(m.local_part,'@',d.name) IN (%k);

(If you want sender white/blacklisting)
$sql_select_white_black_list = 'SELECT w.wb FROM wblist AS w LEFT JOIN
mailboxes AS m ON w.mailbox_id = m.id LEFT JOIN domains AS d ON m.domain_id = d.id
WHERE w.sender = ? AND CONCAT(m.local_part,'@',d.name) IN (%k);

- Evaluate alternatives to Amavis:
http://wiki.apache.org/spamassassin/MailProxy
http://www.worlddesign.com/index.cfm/rd/mta/spampd.htm#download

- Evaluate alternatives to postgrey
Make sure class-C ip subnet auto-whitelists are supported

- Allow dynamic mysql lookup tables in recipient checks?

- Templates:
-- Add XML templates
-- Add CSV templates
-- Add alternate styles
-- Add plaintext templates

###########################################################################
Content Scanning
###########################################################################
What we got:
- Amavis (SMTP-Proxy)
-- SpamAssassin
-- Tagging
-- AV Scanner
-- Header Checks (Postfix does that)
-- Black/White listing
- Policyd-Weight (Policy-Service)
-- RBL Checks (Postfix does that partly)
- Postgrey (Policy Service)
-- Greylisting

What we want:
- SpamAssassin (per User, optional tagging)
- Max_msg_size
- Whitelisting
- Blacklisting
- Greylisting
-- intelligent greylisting with enhanced growing-subnet AWL
- Weighted RBLs

Adopt SpamPD for SMTP-Proxy, enhance with SQL queries to do:
- whitelisting
- blacklisting
- max_msg_size checks

Adopt e.g. Postgrey, enhance with smart AWL (e.g. from SQLgrey)
and weighted policy checks.

Brainstorming:
- Use policyd-weight (RBL checks) + custom policyd (max_msg_size, greylisting)
- Custom Policyd must be invoked twice: In stage RCPT (greylisting) and stage DATA (max_msg_size)

It looks like size is undef for bigger messages. Perhaps the max_msg_size check must be done
in the smtp proxy ... size is availabe in end_of_data restrictions, but recipient
information is lost if more the one is specified, so we need to move this to the spam-proxy.

- Use Custom SMTP-Proxy or smtppd for SA

###########################################################################
Postfix:
###########################################################################

virtual_alias_maps (Aliases):
SELECT goto FROM aliases AS a LEFT JOIN domains AS d ON a.domain_id = d.id WHERE d.name = '%d' AND a.local_part = '%u' AND a.is_active AND d.is_active

virtual_alias_domain_maps (Domain-Alias Aliases):
SELECT goto FROM aliases AS a LEFT JOIN domains AS d ON a.domain_id = d.id LEFT JOIN domain_aliases AS da ON da.domain_id = d.id WHERE da.name = '%d' AND a.local_part = '%u' AND a.is_active AND d.is_active AND da.is_active

virtual_domain_maps (Domains):
SELECT name FROM domains WHERE name = '%s' AND is_active

virtual_domain_alias_maps (Domain-Aliases):
SELECT name FROM domain_aliases WHERE name = '%s' AND is_active

virtual_mailbox_maps (Mailboxes / Maildirs ):
SELECT CONCAT(d.name, '/', m.local_part) AS maildir FROM domains AS d LEFT JOIN mailboxes AS m ON m.domain_id = d.id WHERE d.name = '%d' AND m.local_part = '%d' AND d.is_active AND m.is_active

virtual_alias_domain_mailbox_maps (Domain-Alias-Mailboxen):
SELECT CONCAT(d.name, '/', m.local_part) AS maildir FROM domains AS d LEFT JOIN mailboxes AS m ON m.domain_id = d.id LEFT JOIN domain_aliases AS da ON da.domain_id = d.id WHERE da.name = '%d' AND m.local_part = '%u' AND d.is_active AND m.is_active

virtual_vacation_alias_maps (Vacation Mailbox Aliases):
SELECT CONCAT(ma.local_part,'#',d.name,'@autoreply.domain.tld') AS goto FROM mailboxes AS ma LEFT JOIN domains AS d ON ma.domain_id = d.id WHERE is_on_vacation AND d.name = '%d' AND ma.local_part = '%u'

### main.cf ###
# See /usr/share/postfix/main.cf.dist for a commented, more complete version


# Debian specific:  Specifying a file name will cause the first
# line of that file to be used as the name.  The Debian default
# is /etc/mailname.
#myorigin = /etc/mailname

smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU)
biff = no

# appending .domain is the MUA's job.
append_dot_mydomain = no

# Uncomment the next line to generate "delayed mail" warnings
#delay_warning_time = 4h

readme_directory = no

# TLS parameters
smtpd_tls_cert_file = /etc/ssl/certs/vs-mail-pf.pem
smtpd_tls_key_file = /etc/ssl/private/vs-mail-pf.key
smtpd_use_tls = yes
smtp_use_tls = yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc package for
# information on enabling SSL in the smtp client.

myhostname = host.domain.tld
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = host.domain.tld, localhost
relayhost = 
mynetworks = 192.168.XX.0/24 10.8.0.0/16 [::1]/128
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all
inet_protocols = all
#inet_protocols = ipv4
virtual_mailbox_domains =
	proxy:mysql:/etc/postfix/maps/virtual_domain_maps.cf,
	proxy:mysql:/etc/postfix/maps/virtual_domain_alias_maps.cf
virtual_mailbox_maps =
	proxy:mysql:/etc/postfix/maps/virtual_mailbox_maps.cf,
	proxy:mysql:/etc/postfix/maps/virtual_alias_domain_mailbox_maps.cf
virtual_alias_maps =
	proxy:mysql:/etc/postfix/maps/virtual_alias_maps.cf,
	proxy:mysql:/etc/postfix/maps/virtual_alias_domain_maps.cf
virtual_transport = dovecot
dovecot_destination_recipient_limit = 1
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_auth_enable = yes
smtpd_recipient_restrictions =
# Postmaster, abuse und andere role-accounts
        check_recipient_access btree:/etc/postfix/maps/access_recipient-rfc,
# White- und Blacklisting
        check_client_access btree:/etc/postfix/maps/access_client,
        check_helo_access btree:/etc/postfix/maps/access_helo,
        check_sender_access btree:/etc/postfix/maps/access_sender,
        check_recipient_access btree:/etc/postfix/maps/access_recipient,
# Keine unsauberen Mails annehmen!
        reject_non_fqdn_sender,
        reject_non_fqdn_recipient,
        reject_unknown_sender_domain,
        reject_unknown_recipient_domain,
# Unsere Nutzer erlauben!
        permit_sasl_authenticated,
        permit_mynetworks,
# Testweise folgende rejects:
        reject_invalid_helo_hostname,
        reject_unknown_helo_hostname,
        reject_non_fqdn_helo_hostname,
        reject_unknown_client_hostname,
        reject_unknown_reverse_client_hostname,
# RBL checken
        reject_rbl_client ix.dnsbl.manitu.net,
        reject_rbl_client zen.spamhaus.org,
#       reject_rbl_client bl.spamcop.net,
#       reject_rbl_client dnsbl.njabl.org,
#       reject_rbl_client list.dsbl.org,
#       reject_rhsbl_client blackhole.securitysage.com,
#       reject_rhsbl_sender dsn.rfc-ignorant.org
# Greylisting
        check_policy_service inet:127.0.0.1:60000,
# TODO policy service to check msg size!
#		check_policy_service inet:127.0.0.1:60010,
# Backup-MX: existierende Relay-Empfänger dyn. prüfen
#       reject_unverified_recipient,
# Backup-MX: erlauben
#       permit_mx_backup,
# Restliches Relaying verbieten,
        reject_unauth_destination,
# Policyd-Weight
        check_policy_service inet:127.0.0.1:12525,
# Rest erlauben
        permit
smtpd_tls_auth_only = no
#content_filter = smtp-amavis:[127.0.0.1]:10024
receive_override_options = no_address_mappings
milter_default_action = accept
milter_protocol = 2
anvil_status_update_time = 600s
anvil_rate_time_unit = 60s
smtpd_client_connection_rate_limit = 60
smtpd_client_connection_count_limit = 25
smtpd_client_message_rate_limit = 1000
smtpd_client_recipient_rate_limit = 1000
maximal_queue_lifetime = 3d
bounce_queue_lifetime = 2d
default_database_type = btree
message_size_limit = 26214400
2bounce_notice_recipient = postmaster
# Vacation
transport_maps = btree:/etc/postfix/maps/transport

### transport ###
# content of /etc/postfix/maps/transport
autoreply.domain.tld	vacation:

### access_client ###
# Block or allow Client access based on IP (NO CIDR!)
# use OK to allow (Whitelist) and REJEXT <TEXT> to block
# 127.0.0.1     OK
# 127.0.0.2     REJECT Go away

### access_helo ##
# Block or allow Helo access based on host or IP (NO CIDR!) 
# use OK to allow (Whitelist) and REJEXT <TEXT> to block
# 127.0.0.1     OK
# 127.0.0.2     REJECT Go away

### access_recipient ###
# Block or allow Recipient access based on host, IP (NO CIDR!) or address
# use OK to allow (Whitelist) and REJEXT <TEXT> to block
# 127.0.0.1     OK
# 127.0.0.2     REJECT Go away

### access_sender ###
# Block or allow Sender access based on host, IP (NO CIDR!) or sender address
# use OK to allow (Whitelist) and REJEXT <TEXT> to block
# 127.0.0.1     OK
# 127.0.0.2     REJECT Go away

### access_recipient-rfc ###
# Allow RFC2142 Accounts                                                                                                                                                
postmaster@             OK                                                                                                                                              
abuse@                  OK

### master.cf ###
#
# Postfix master process configuration file.  For details on the format
# of the file, see the master(5) manual page (command: "man 5 master").
#
# Do not forget to execute "postfix reload" after editing this file.
#
# ==========================================================================
# service type  private unpriv  chroot  wakeup  maxproc command + args
#               (yes)   (yes)   (yes)   (never) (100)
# ==========================================================================
smtp      inet  n       -       -       -       -       smtpd
  -o smtpd_proxy_filter=localhost:10024
submission inet n       -       -       -       -       smtpd
  -o smtpd_tls_security_level=encrypt
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_client_restrictions=permit_sasl_authenticated,reject
  -o milter_macro_daemon_name=ORIGINATING
  -o smtpd_proxy_filter=localhost:10024
smtps     inet  n       -       -       -       -       smtpd
  -o smtpd_tls_wrappermode=yes
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_client_restrictions=permit_sasl_authenticated,reject
  -o milter_macro_daemon_name=ORIGINATING
  -o smtpd_proxy_filter=localhost:10024
#628      inet  n       -       -       -       -       qmqpd
pickup    fifo  n       -       -       60      1       pickup
  -o content_filter=smtp-amavis:[localhost]:10024
cleanup   unix  n       -       -       -       0       cleanup
qmgr      fifo  n       -       n       300     1       qmgr
#qmgr     fifo  n       -       -       300     1       oqmgr
tlsmgr    unix  -       -       -       1000?   1       tlsmgr
rewrite   unix  -       -       -       -       -       trivial-rewrite
bounce    unix  -       -       -       -       0       bounce
defer     unix  -       -       -       -       0       bounce
trace     unix  -       -       -       -       0       bounce
verify    unix  -       -       -       -       1       verify
flush     unix  n       -       -       1000?   0       flush
proxymap  unix  -       -       n       -       -       proxymap
proxywrite unix -       -       n       -       1       proxymap
smtp      unix  -       -       -       -       -       smtp
# When relaying mail as backup MX, disable fallback_relay to avoid MX loops
relay     unix  -       -       -       -       -       smtp
        -o smtp_fallback_relay=
#       -o smtp_helo_timeout=5 -o smtp_connect_timeout=5
showq     unix  n       -       -       -       -       showq
error     unix  -       -       -       -       -       error
retry     unix  -       -       -       -       -       error
discard   unix  -       -       -       -       -       discard
local     unix  -       n       n       -       -       local
virtual   unix  -       n       n       -       -       virtual
lmtp      unix  -       -       -       -       -       lmtp
anvil     unix  -       -       -       -       1       anvil
scache    unix  -       -       -       -       1       scache
# Interface to AMaViS
smtp-amavis unix -      -       n       -       15  smtp
    -o smtp_data_done_timeout=1800
    -o smtp_send_xforward_command=yes
    -o disable_dns_lookups=yes
    -o max_use=20
    -o smtpd_milters=
    -o non_smtpd_milters=
127.0.0.1:10025 inet n  -       -       -       -       smtpd
    -o content_filter=
    -o local_recipient_maps=
    -o relay_recipient_maps=
    -o smtpd_restriction_classes=
    -o smtpd_delay_reject=no
    -o smtpd_client_restrictions=permit_mynetworks,reject
    -o smtpd_helo_restrictions=
    -o smtpd_sender_restrictions=
    -o smtpd_recipient_restrictions=permit_mynetworks,reject
    -o smtpd_data_restrictions=reject_unauth_pipelining
    -o smtpd_end_of_data_restrictions=
    -o smtpd_proxy_filter=
    -o mynetworks=127.0.0.0/8
    -o smtpd_error_sleep_time=0
    -o smtpd_soft_error_limit=1001
    -o smtpd_hard_error_limit=1000
    -o smtpd_client_connection_count_limit=0
    -o smtpd_client_connection_rate_limit=0
    -o receive_override_options=no_header_body_checks,no_unknown_recipient_checks
    -o local_header_rewrite_clients=
    -o smtpd_milters=
    -o non_smtpd_milters=
#
# ====================================================================
# Interfaces to non-Postfix software. Be sure to examine the manual
# pages of the non-Postfix software to find out what options it wants.
#
# Many of the following services use the Postfix pipe(8) delivery
# agent.  See the pipe(8) man page for information about ${recipient}
# and other message envelope options.
# ====================================================================
#
# maildrop. See the Postfix MAILDROP_README file for details.
# Also specify in main.cf: maildrop_destination_recipient_limit=1
#
maildrop  unix  -       n       n       -       -       pipe
  flags=DRhu user=vmail argv=/usr/bin/maildrop -d ${recipient}
#
# See the Postfix UUCP_README file for configuration details.
#
uucp      unix  -       n       n       -       -       pipe
  flags=Fqhu user=uucp argv=uux -r -n -z -a$sender - $nexthop!rmail ($recipient)
#
# Other external delivery methods.
#
ifmail    unix  -       n       n       -       -       pipe
  flags=F user=ftn argv=/usr/lib/ifmail/ifmail -r $nexthop ($recipient)
bsmtp     unix  -       n       n       -       -       pipe
  flags=Fq. user=bsmtp argv=/usr/lib/bsmtp/bsmtp -t$nexthop -f$sender $recipient
scalemail-backend unix  -       n       n       -       2       pipe
  flags=R user=scalemail argv=/usr/lib/scalemail/bin/scalemail-store ${nexthop} ${user} ${extension}
mailman   unix  -       n       n       -       -       pipe
  flags=FR user=list argv=/usr/lib/mailman/bin/postfix-to-mailman.py
  ${nexthop} ${user}
dovecot   unix  -       n       n       -       -       pipe
  flags=DRhu user=vmail:vmail argv=/usr/lib/dovecot/deliver -d ${user}@${domain}
#vacation  unix	-		n		n		-		-		pipe
#  flags=Rq user=vacation argv=/usr/bin/vacation -f ${sender} -- ${recipient}

###########################################################################
Dovecot:
###########################################################################
default_pass_scheme = PLAIN
password_query = SELECT CONCAT(m.local_part, '@', d.name) AS user, m.password AS password FROM mailboxes AS m LEFT JOIN domains AS d ON m.domain_id = d.id WHERE m.local_part = '%n' AND d.name = '%d' AND m.is_active AND d.is_active

### dovecot.conf ###
# /etc/dovecot# egrep -v '^\s*#' dovecot.conf | egrep -v '^$'
protocols = imap imaps pop3 pop3s managesieve
listen=[::]
disable_plaintext_auth = no
log_timestamp = "%Y-%m-%d %H:%M:%S "
syslog_facility = mail
ssl_cert_file = /etc/ssl/certs/vs-mail-pf.pem
ssl_key_file = /etc/ssl/private/vs-mail-pf.key
mail_location = maildir:/srv/vmail/%d/%n/Maildir
mail_privileged_group = mail
protocol imap {
  mail_plugins = quota imap_quota
}
  
protocol pop3 {
  pop3_uidl_format = %08Xu%08Xv
  mail_plugins = quota
}
protocol managesieve {
  sieve=~/.dovecot.sieve
  sieve_storage=~/sieve
}
protocol lda {
  postmaster_address = postmaster@domain.tld
  mail_plugins = quota
  auth_socket_path = /var/run/dovecot/auth-master
  mail_plugins = cmusieve
  log_path = /var/vmail/dovecot-deliver.log
}
auth default {
  mechanisms = plain login
  passdb sql {
    args = /etc/dovecot/dovecot-sql.conf
  }
  userdb passwd {
  }
  userdb static {
    args = uid=5000 gid=5000 home=/srv/vmail/%d/%n allow_all_users=yes
  }
  user = root
  socket listen {
    master {
      path = /var/run/dovecot/auth-master
      mode = 0600
      user = vmail
    }
    client {
      path = /var/spool/postfix/private/auth
      mode = 0660
      user = postfix
      group = postfix
    }
  }
}
dict {
}
plugin {
  quota = maildir:storage=5000000
  sieve_global_path = /var/vmail/globalsieverc
}
